### 高级工程师任务执行规则（本次会话小结）

- **目标**: 成功在 8×8 Ray 集群上运行 DAPO 训练脚本。
- **关键修复**:
  - 修正 Hydra 搜索路径，解决 `MissingConfigException`。
  - 激活 conda 环境，解决 `ModuleNotFoundError: hydra`。
  - 指导 Ray 资源配置，避免 `Total available GPUs < desired`。
  - 模型同步与校验，修复 HFValidationError 与 `MetadataIncompleteBuffer` 的根因（不一致/损坏），并提供一致性校验脚本。
  - FlashAttention2 dtype：在脚本中设置 `torch_dtype=bfloat16`。
  - vLLM 上下文长度：在 Ray runtime_env 注入 `VLLM_ALLOW_LONG_MAX_MODEL_LEN=1`，并在启动脚本中导出同名环境变量。
  - 修复 `UnboundLocalError: torch`：移除函数内 `import torch` 的局部遮蔽。
- **脚本与代码变更**:
  - 编辑 `recipe/dapo/run_dapo_analysis.sh`：
    - 导出 `VLLM_ALLOW_LONG_MAX_MODEL_LEN=1`
    - 追加 `+actor_rollout_ref.model.torch_dtype=bfloat16`（与 override 并存以稳妥）
  - 编辑 `verl/trainer/constants_ppo.py`：
    - 在 `PPO_RAY_RUNTIME_ENV` 的 `env_vars` 中加入 `VLLM_ALLOW_LONG_MAX_MODEL_LEN=1`
  - 编辑 `verl/trainer/ppo/ray_trainer.py`：
    - 移除 `fit` 内部的 `import torch`，避免局部变量覆盖
- **注意**:
  - nohup 用法：应使用 `env VAR=... VAR2=... bash ... &` 或先 `export` 再 `nohup bash ... &`，不要把 `RAY_ADDRESS=auto` 放在可执行位。

- **当前建议启动命令**：
  - 前台运行：`RAY_ADDRESS=auto NNODES=8 NGPUS_PER_NODE=8 bash recipe/dapo/run_dapo_analysis.sh`
  - 后台运行：`nohup env RAY_ADDRESS=auto NNODES=8 NGPUS_PER_NODE=8 bash recipe/dapo/run_dapo_analysis.sh > train.out 2>&1 &`

- **风险/假设**:
  - 若个别节点模型分片仍损坏，需以完好节点为源通过 rsync 覆盖。
  - 若 vLLM 仍提示 max_model_len 超限，检查远端 env 继承（我们已在 runtime_env 注入）。

